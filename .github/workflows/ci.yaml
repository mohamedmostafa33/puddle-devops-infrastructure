name: CI Pipeline

on:
  workflow_dispatch:

  push:
    branches:
      - test

  pull_request:
    branches:
      - main

env:
    AWS_REGION: us-east-1
    AWS_BUCKET_NAME: puddle-s3-media-nti
    AWS_S3_REGION_NAME: us-east-1
    AWS_S3_CUSTOM_DOMAIN: puddle-s3-media-nti.s3.amazonaws.com
    USE_S3: true
    
jobs:

  detect-changes:
    name: Detect Application changes
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.detect_changes.outputs.app }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect app changes
        id : detect_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app:
              - 'src/**'
          list-files: json
          token: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build and Test Application
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.app_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install coverage

      - name: Create .env file
        working-directory: src
        run: |
          cat > .env << EOF
          DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_DEBUG=False
          DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1
          DJANGO_CSRF_TRUSTED_ORIGINS=http://localhost
          DATABASE_URL=sqlite:///db.sqlite3
          DJANGO_EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
          DJANGO_SECURE=False
          USE_S3=${{ env.USE_S3 }}
          AWS_BUCKET_NAME=${{ env.AWS_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_REGION_NAME=${{ env.AWS_S3_REGION_NAME }}
          AWS_S3_CUSTOM_DOMAIN=${{ env.AWS_S3_CUSTOM_DOMAIN }}
          EOF

      - name: Collect static files
        working-directory: src
        run: |
          python manage.py collectstatic --noinput

      - name: Run Django tests with coverage
        working-directory: src
        run: |
          coverage run --source='.' manage.py test
          coverage report
          coverage xml

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [build, detect-changes]
    if: needs.detect-changes.outputs.app_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get commit SHA
        id: get-sha
        run: echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build Docker image with commit SHA
        run: |
          docker build -t puddle-app:v${{ env.COMMIT_SHA }} -f src/Dockerfile ./src

      - name: Tag Docker image for ECR
        run: |
          docker tag puddle-app:v${{ env.COMMIT_SHA }} ${{ secrets.ECR_URL }}:${{ env.COMMIT_SHA }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_URL }}
      
      - name: Push Docker image to ECR
        run: |
          docker push ${{ secrets.ECR_URL }}:${{ env.COMMIT_SHA }}
          echo "Pushed: ${{ secrets.ECR_URL }}:${{ env.COMMIT_SHA }}"
          
      - name: Update helm values file
        run: |
          sed -i 's|image: .*|image: '"${{ secrets.ECR_URL }}:${{ env.COMMIT_SHA }}"'|g' helm/values.yaml

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git checkout -b update-image-${{ env.COMMIT_SHA }}
          git add helm/values.yaml
          git commit -m "Update Docker image to ${{ env.COMMIT_SHA }}"
          git push origin update-image-${{ env.COMMIT_SHA }}